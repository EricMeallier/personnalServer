export NEW_VERSION=24.0.0
export OLD_VERSION=23.0.3

cd /opt/nextcloud
sudo -u nobody php7.3 occ maintenance:mode --on

cd /opt
# remove current link version
sudo rm nextcloud

# unzip new verion
sudo wget  https://download.nextcloud.com/server/releases/nextcloud-${NEW_VERSION}.zip
sudo unzip nextcloud-${NEW_VERSION}.zip

# link update
sudo mv nextcloud nextcloud-${NEW_VERSION}
sudo ln -s /opt/nextcloud-${NEW_VERSION} /opt/nextcloud
sudo chown -R nobody:nogroup nextcloud/

# move configuration from old installation
sudo cp -a nextcloud-${OLD_VERSION}/config/config.php nextcloud/config
sudo cp -a nextcloud-${OLD_VERSION}/apps/bookmarks nextcloud/apps
sudo cp -a nextcloud-${OLD_VERSION}/apps/spreed nextcloud/apps
sudo cp -a nextcloud-${OLD_VERSION}/apps/deck nextcloud/apps
sudo cp -a nextcloud-${OLD_VERSION}/apps/mail nextcloud/apps
sudo cp -a nextcloud-${OLD_VERSION}/apps/twofactor_totp nextcloud/apps
sudo cp -a nextcloud-${OLD_VERSION}/apps/notes nextcloud/notes

# restart services
sudo systemctl restart nginx
sudo systemctl restart php8.0-fpm

# upgrade to version
cd /opt/nextcloud
sudo -u nobody php8.0 occ upgrade

# disable maintenance mode
sudo -u nobody php8.0 occ maintenance:mode --off
