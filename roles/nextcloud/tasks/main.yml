---

- name: adding php repository
  shell: 'echo deb https://packages.sury.org/php/ bullseye main > /etc/apt/sources.list.d/php.list'

- name: adding php repository gpg key
  get_url:
    url: https://packages.sury.org/php/apt.gpg
    dest: /etc/apt/trusted.gpg.d/php.gpg

- name: install nextcloud pre requisites
  apt: 
    name:
    - php{{ php.version }}-fpm
    - php{{ php.version }}-common
    - php{{ php.version }}-gd
    - php{{ php.version }}-pgsql
    - php{{ php.version }}-curl
    - php{{ php.version }}-mbstring
    - php{{ php.version }}-xml
    - php{{ php.version }}-intl
    - php{{ php.version }}-zip
    - php{{ php.version }}-gmp
    - php{{ php.version }}-redis
    - php{{ php.version }}-bcmath
    - php{{ php.version }}-imagick
    state: present
    update_cache: yes

- name: Is already installed ?
  stat:
    path: "/opt/nextcloud/config/config.php"
  register: already_installed

- name: Is already downloaded ?
  stat:
    path: "'/tmp/nextcloud-{{package.version}}.zip'"
  register: nextcloud_zip

- name: Download nextcloud files
  get_url:
    url: https://download.nextcloud.com/server/releases/nextcloud-{{package.version}}.zip
    dest: '/tmp/nextcloud-{{package.version}}.zip'
  when: not nextcloud_zip.stat.exists is defined or not nextcloud_zip.stat.exists

- name: Backup old installation (config), if needed
  copy:
    remote_src: true
    src: '/opt/nextcloud/config/config.php'
    dest: '/opt/config.php'
  ignore_errors: true
  when: already_installed.stat.exists is defined and already_installed.stat.exists

- name: Backup old installation (apps), if needed
  copy:
    remote_src: true
    src: '/opt/nextcloud/apps/{{ item }}'
    dest: '/opt/{{ item }}'
    owner: 'nobody'
    group: 'nogroup'
  ignore_errors: true
  loop: "{{ package.appsToRestore }}"
  when: already_installed.stat.exists is defined and already_installed.stat.exists

- name: Cleanup target folder
  file:
    path: '{{ item }}'
    state: absent
  loop:
  - '/opt/nextcloud-{{package.version}}'
  - '/opt/nextcloud'

- name: Extract nextcloud files into /opt
  unarchive:
    src: '/tmp/nextcloud-{{package.version}}.zip'
    dest: /opt
    remote_src: 'yes'
    owner: 'nobody'
    group: 'nogroup'

- name: rename default folder name
  command: 'mv /opt/nextcloud /opt/nextcloud-{{package.version}}'

- name: link to current version
  file:
    src: /opt/nextcloud-{{ package.version }}
    dest: /opt/nextcloud
    state: 'link'
    owner: 'nobody'
    group: 'nogroup'

- name: Copy php FPM configuration file
  template:
    src: www.conf
    dest: /etc/php/{{ php.version }}/fpm/pool.d/www.conf

- name: Configure php FPM to set the memory allowed
  replace:
    dest: '/etc/php/{{ php.version }}/fpm/php.ini'
    regexp: '^memory_limit = .*$'
    replace: 'memory_limit = 512M'

- name: create data directory
  file:
    path: /data/nextcloud
    state: directory
    recurse: yes
    owner: 'nobody'
    group: 'nogroup'

- name: Restore old configuration, if needed
  command: mv /opt/config.php /opt/nextcloud/config/config.php
  when: already_installed.stat.exists is defined and already_installed.stat.exists

- name: Restore old apps, if needed
  command: mv /opt/{{ item }} /opt/nextcloud/apps/{{ item }}
  ignore_errors: true
  loop: "{{ package.appsToRestore }}"
  when: already_installed.stat.exists is defined and already_installed.stat.exists

- name: Create dedicated database
  include_role:
    name : pg_new_fresh_database
  vars:
  - pg_username: '{{ postgresql.nextcloud.username }}'
  - pg_password: '{{ postgresql.nextcloud.password }}'
  - pg_database: '{{ postgresql.nextcloud.database }}'
  when: not already_installed.stat.exists is defined or not already_installed.stat.exists

- name: Configure database (config/config.php)
  shell: 
    cmd: 'sudo -u nobody php{{ php.version }} occ maintenance:install --database "pgsql" --database-name "{{postgresql.nextcloud.database}}" --database-user "{{postgresql.nextcloud.username}}" --database-pass "{{postgresql.nextcloud.password}}" --admin-user "{{nextcloud.admin.username}}" --admin-pass "{{nextcloud.admin.password}}" --data-dir "/data/nextcloud"'
    chdir: '/opt/nextcloud-{{package.version}}'
  when: not already_installed.stat.exists is defined or not already_installed.stat.exists

- name: Force owner of config file
  file:
    path: '/opt/nextcloud/config/config.php'
    owner: 'nobody'
    group: 'nogroup'

- name: Add basics applications, if fresh install
  shell: 
    cmd: 'sudo -u nobody php{{ php.version }} occ app:install {{ item }}'
    chdir: '/opt/nextcloud-{{package.version}}'
  loop: "{{ package.appsToRestore }}"
  when: not already_installed.stat.exists is defined or not already_installed.stat.exists

- name: Mise Ã  jour de l'environnement occ
  shell: 
    cmd: 'sudo -u nobody php{{ php.version }} occ upgrade'
    chdir: '/opt/nextcloud-{{package.version}}'

- name: Configure database (Missing-indices)
  shell: 
    cmd: 'sudo -u nobody php{{ php.version }} occ db:add-missing-indices'
    chdir: '/opt/nextcloud-{{package.version}}'
  when: not already_installed.stat.exists is defined or not already_installed.stat.exists

- name: Configure database (Missing-primary keys)
  shell: 
    cmd: 'sudo -u nobody php{{ php.version }} occ db:add-missing-primary-keys'
    chdir: '/opt/nextcloud-{{package.version}}'
  when: not already_installed.stat.exists is defined or not already_installed.stat.exists

- name: Configure database (Missing-columns)
  shell: 
    cmd: 'sudo -u nobody php{{ php.version }} occ db:add-missing-columns'
    chdir: '/opt/nextcloud-{{package.version}}'
  when: not already_installed.stat.exists is defined or not already_installed.stat.exists

- name: Configure database (convert-filecache-bigint)
  shell: 
    cmd: 'sudo -u nobody php{{ php.version }} occ db:convert-filecache-bigint'
    chdir: '/opt/nextcloud-{{package.version}}'
  when: not already_installed.stat.exists is defined or not already_installed.stat.exists

- name: Configure trusted domains (in config/config.php)
  shell: 
    cmd: 'sudo -u nobody php{{ php.version }} occ config:system:set trusted_domains 0 --value=nextcloud.meallier.fr'
    chdir: '/opt/nextcloud-{{package.version}}'

- name: Configure secure url overwrite (in config/config.php)
  shell: 
    cmd: 'sudo -u nobody php{{ php.version }} occ config:system:set overwrite.cli.url --value=http://nextcloud.meallier.fr'
    chdir: '/opt/nextcloud-{{package.version}}'
  when: redmine_unsecured

- name: Configure url overwrite (in config/config.php)
  shell: 
    cmd: 'sudo -u nobody php{{ php.version }} occ config:system:set overwrite.cli.url --value=https://nextcloud.meallier.fr'
    chdir: '/opt/nextcloud-{{package.version}}'
  when: not redmine_unsecured

- name: nextcloud service reload/start
  systemd:
    name: 'nginx'
    daemon_reload: true
    state: started
    enabled: true

- name: generate redmine certificate
  shell: /usr/bin/certbot certonly -d nextcloud.meallier.fr -m eric@meallier.fr --agree-tos --webroot --no-eff-email --webroot-path /opt/nginx/html  --keep-until-expiring --non-interactive  
  when: not redmine_unsecured
      
# finish installation with ssl termination
- name: Template nginx configuration file
  template:
    src: nextcloud.conf
    dest: /opt/nginx/conf/server/nextcloud.conf

- name: Nginx service restart with full configuration
  systemd:
    name: 'nginx'
    state: restarted

- name: PHP-FPM service restart
  systemd:
    name: 'php{{ php.version }}-fpm'
    state: restarted

- name: Copy emptyTrash script
  template:
    src: nextcloudTrash.sh
    dest: /opt/nextcloudTrash.sh
    mode: 'a+x'

- name: Copy emptyTrash service
  copy:
    src: nextcloudTrash.service
    dest: /etc/systemd/system/nextcloudTrash.service
    owner: root
    group: root
    mode: '0644'

- name: Copy emptyTrash timer
  copy:
    src: nextcloudTrash.timer
    dest: /etc/systemd/system/nextcloudTrash.timer
    owner: root
    group: root
    mode: '0644'

- name: Enabling emptyTrash timer
  systemd:
    name: 'nextcloudTrash.timer'
    enabled: yes

- name: logrotate configuration
  copy:
    src: logrotate
    dest: /etc/logrotate.d/nextcloud