---

- name: adding php repository
  shell: 'echo deb https://packages.sury.org/php/ bullseye main > /etc/apt/sources.list.d/php.list'

- name: adding php repository gpg key
  get_url:
    url: https://packages.sury.org/php/apt.gpg
    dest: /etc/apt/trusted.gpg.d/php.gpg

- name: install nextcloud pre requisites
  apt: 
    name:
    - php8.0-fpm
    - php8.0-common
    - php8.0-gd
    - php8.0-pgsql
    - php8.0-curl
    - php8.0-mbstring
    - php8.0-xml
    - php8.0-intl
    - php8.0-zip
    - php8.0-gmp
    - php8.0-redis
    state: present
    update_cache: yes

- name: Download next files
  get_url:
    url: https://download.nextcloud.com/server/releases/nextcloud-{{nextcloud.version}}.zip
    dest: '/tmp/nextcloud-{{nextcloud.version}}.zip'

- name: Extract nextcloud files into /opt
  unarchive:
    src: '/tmp/nextcloud-{{nextcloud.version}}.zip'
    dest: /opt
    remote_src: 'yes'
    owner: nobody
    group: nogroup

- name: Copy php FPM configuration file
  copy:
    src: www.conf
    dest: /etc/php/8.0/fpm/pool.d/www.conf

- name: Configure database (config/config.php)
  shell: 'sudo -u nobody php8.0 occ maintenance:install --install --database "pgsql" --database-name "{{postgresql.nextcloud.database}}"  --database-user "{{postgresql.nextcloud.username}}" --database-pass "{{postgresql.nextcloud.password}}" --admin-user "{{nextcloud.admin_username}}" --admin-pass "{{nextcloud.admin_password}}" --data-dir "/opt/nextcloud/data"'

- name: Configure trusted domains (config/config.php)
  shell: 'sudo -u nobody php8.0 occ  config:system:set trusted_domains 0 --value=nextcloud.meallier.fr'

- name: Configure secure url overwrite (config/config.php)
  shell: 'sudo -u nobody php8.0 occ  config:system:set overwrite.cli.url --value=https://nextcloud.meallier.fr'
  when: redmine_unsecured

- name: Configure url overwrite (config/config.php)
  shell: 'sudo -u nobody php8.0 occ  config:system:set overwrite.cli.url --value=http://nextcloud.meallier.fr'
  when: not redmine_unsecured

- name: 'Insecure configuration (for Vagrant)'
  include: unsecure.yml
  when: redmine_unsecured
    
- name: 'Secure configuration (for Internet)'
  include: secure.yml
  when: not redmine_unsecured

- name: PHP-FPM service restart
  systemd:
    name: 'php8.0-fpm'
    state: restarted

- name: Copy emptyTrash script
  copy:
    src: nextcloudTrash.sh
    dest: /opt/nextcloudTrash.sh
    mode: 'a+x'

- name: Copy emptyTrash service
  copy:
    src: nextcloudTrash.service
    dest: /etc/systemd/system/nextcloudTrash.service
    owner: root
    group: root
    mode: '0644'

- name: Copy emptyTrash timer
  copy:
    src: nextcloudTrash.timer
    dest: /etc/systemd/system/nextcloudTrash.timer
    owner: root
    group: root
    mode: '0644'

- name: Enabling emptyTrash timer
  systemd:
    name: 'nextcloudTrash.timer'
    enabled: yes

- name: logrotate configuration
  copy:
    src: logrotate
    dest: /etc/logrotate.d/nextcloud