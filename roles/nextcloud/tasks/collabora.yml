---

# Collabora standalone server

- name: Update DNS
  include_role:
    name : update_infomaniak_dns
  vars:
    targetExtension : '{{office.domain.suffix}}'
    targetIP: '{{ansible_default_ipv4.address}}'
  when: not redmine_unsecured

- name: Download repo certificate
  get_url:
    url: https://collaboraoffice.com/downloads/gpg/collaboraonline-release-keyring.gpg
    dest: '/etc/apt/keyrings/collaboraonline-release-keyring.gpg'

- name: Add repo source
  copy:
    src: collaboraonline.sources
    dest: /etc/apt/sources.list.d/collaboraonline.sources
    owner: root
    group: root
    mode: '0644'

- name: Install Collabora package
  apt: 
    name:
    - coolwsd
    - code-brand
    state: 'latest'
    update_cache: yes

- name: Collabora config - termination SSL
  shell: 
    cmd: 'coolconfig set ssl.termination true'

- name: Collabora config - enable SSL
  shell: 
    cmd: 'coolconfig set ssl.enable false'

- name: Collabora config - admin username
  shell: 
    cmd: 'coolconfig set admin_console.username {{ office.admin.username }}'

- name: Collabora config - admin password
  shell: 
    cmd: 'coolconfig set admin_console.password {{ office.admin.password }}'

- name: Collabora config - Post Allow host
  shell: 
    cmd: 'coolconfig set net.post_allow.host 127.0.0.1/32'

- name: Collabora config - Max coucurrency
  shell: 
    cmd: 'coolconfig set  per_document.max_concurrency 1'

- name: Collabora service start
  systemd:
    name: 'coolwsd'
    state: restarted

- name: generate office certificate
  shell: /usr/bin/certbot certonly -d {{ office.domain.suffix }}.{{ server.domain.sub}}{{server.domain.main }} -m {{ server.domain.contact }} --agree-tos --webroot --no-eff-email --webroot-path /opt/nginx/html  --keep-until-expiring --non-interactive
  when: not redmine_unsecured

# finish installation with ssl termination
- name: Copy full nginx ssl configuration file
  template:
    src: office.conf
    dest: /opt/nginx/conf/server/office.conf

- name: nextcloud service reload/start
  systemd:
    name: 'nginx'
    state: restarted

- name: Wopi public config URL secure
  shell: 
    cmd: 'sudo -u nobody php{{ php.version }} occ config:app:set richdocuments public_wopi_url --value="https://{{ office.domain.suffix }}.{{ server.domain.sub}}{{server.domain.main }}"'
    chdir: '/opt/nextcloud-{{package.version}}'
  when: not redmine_unsecured

- name: Wopi config URL secure
  shell: 
    cmd: 'sudo -u nobody php{{ php.version }} occ config:app:set richdocuments wopi_url --value="https://{{ office.domain.suffix }}.{{ server.domain.sub}}{{server.domain.main }}"'
    chdir: '/opt/nextcloud-{{package.version}}'
  when: not redmine_unsecured

- name: Wopi public config URL unsecure
  shell: 
    cmd: 'sudo -u nobody php{{ php.version }} occ config:app:set richdocuments public_wopi_url --value="http://{{ office.domain.suffix }}.{{ server.domain.sub}}{{server.domain.main }}"'
    chdir: '/opt/nextcloud-{{package.version}}'
  when: redmine_unsecured

- name: Wopi config URL unsecure
  shell: 
    cmd: 'sudo -u nobody php{{ php.version }} occ config:app:set richdocuments wopi_url --value="http://{{ office.domain.suffix }}.{{ server.domain.sub}}{{server.domain.main }}"'
    chdir: '/opt/nextcloud-{{package.version}}'
  when: redmine_unsecured

- name: Restrict WOPI host list => not working as wish
  shell: 
    cmd: "sudo -u nobody php{{ php.version }} occ config:app:set richdocuments wopi_allowlist --value='95.179.212.183,fe80::af95:a8b:2dc3:f8e6'"
    chdir: '/opt/nextcloud-{{package.version}}'

- name: Add richdocuments nextcloud application
  shell: 
    cmd: 'sudo -u nobody php{{ php.version }} occ app:install richdocuments'
    chdir: '/opt/nextcloud-{{package.version}}'

- name: Enable richdocuments nextcloud application
  shell: 
    cmd: 'sudo -u nobody php{{ php.version }} occ app:enable richdocuments'
    chdir: '/opt/nextcloud-{{package.version}}'

- name: App RichDocuments activating
  shell: 
    cmd: 'sudo -u nobody php{{ php.version }} occ richdocuments:activate-config'
    chdir: '/opt/nextcloud-{{package.version}}'
  