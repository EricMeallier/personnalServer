---

- name: install nodejs pre requisites
  apt: 
    name:
    - dirmngr
    - apt-transport-https
    - lsb-release
    - ca-certificates
    state: present

- name: install nodejs v16 dedicated repo
  shell: '/usr/bin/curl -sL https://deb.nodesource.com/setup_16.x | sudo -E bash -'

- name: install nodejs
  apt: 
    name:
    - nodejs
    state: present

- name: Ensure group "etherpad" exists
  group:
    name: etherpad
    state: present

- name: Add the user 'etherpad'
  user:
    name: etherpad
    group: etherpad

- name: Download etherpad files
  get_url:
    url: https://github.com/ether/etherpad-lite/archive/{{ etherpad.version }}.zip
    dest: '/tmp/etherpad-{{ etherpad.version }}.zip'
    timeout: 30

- name: Extract etherpad files into /opt
  unarchive:
    src: '/tmp/etherpad-{{ etherpad.version }}.zip'
    dest: /opt
    remote_src: 'yes'
    owner: etherpad
    group: etherpad

- name: link to current version
  file:
    src: /opt/etherpad-lite-{{ etherpad.version }}
    dest: /opt/etherpad-lite
    state: 'link'
    owner: 'etherpad'
    group: 'etherpad'

- name: Copy database configuration file
  template:
    src: settings.json
    dest: /opt/etherpad-lite/settings.json
    owner: etherpad
    group: etherpad
    mode: '0644'

- name: retrieve dependencies
  shell: /opt/etherpad-lite/bin/installDeps.sh
  become_user: 'etherpad'

- name: Install etherpad service script
  copy:
    src: etherpad.service
    dest: /etc/systemd/system/etherpad.service
    owner: root
    group: root
    mode: '0644'

- name: etherpad service reload/start
  systemd:
    name: 'etherpad'
    daemon_reload: true
    state: restarted
    enabled: true
  
- name: 'Insecure configuration (for Vagrant)'
  include: unsecure.yml
  when: redmine_unsecured
    
- name: 'Secure configuration (for Internet)'
  include: secure.yml
  when: not redmine_unsecured
